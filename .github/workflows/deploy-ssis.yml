name: SSIS Build and Deploy

on:
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: windows-latest

    steps:
    # Step 1: Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 2: Setup SSIS tools
    - name: Setup SQL Server SSIS DevOps Tools
      uses: jonlabelle/setup-ssis-devops-tools@v1

    # Step 3: Build SSIS project
    - name: Build SSIS Package
      run: |
        # Force create output directory
        mkdir "${{ github.workspace }}\SSISOutput" -Force
        
        # Build with Development configuration
        SSISBuild.exe `
          -p:"${{ github.workspace }}\MigratingTimesheet\MigratingTimesheet.dtproj" `
          -o:"${{ github.workspace }}\SSISOutput" `
          -c:Development
        
        # Verify the exact output location
        dir "${{ github.workspace }}\SSISOutput" -Recurse

    # Step 4: Deploy SSIS package
    - name: Deploy SSIS Package
      run: |
        $ispacPath = "${{ github.workspace }}\SSISOutput\Development\MigratingTimesheet.ispac"
        Write-Output "Looking for .ispac at: $ispacPath"
        
        if (-not (Test-Path $ispacPath)) {
          Write-Error "ERROR: .ispac file not found at expected location!"
          dir "${{ github.workspace }}\SSISOutput" -Recurse
          exit 1
        }
        
        SSISDeploy.exe `
          -s:"$ispacPath" `
          -d:"catalog;/SSISDB/TimesheetDeploy/MigratingTimesheet;LAPTOP-62JJ49T4" `
          -at:SQL `
          -u:Auto_user `
          -p:SecurePass2025
